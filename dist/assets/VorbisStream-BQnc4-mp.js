import{A as F,U as r,S as y,b as w,r as i,t as L,m as S}from"./useAudioMetadata-Dr-ZpCn7.js";class h{static fromBase64(e){return h.fromBuffer(Uint8Array.from(atob(e),t=>t.charCodeAt(0)))}static fromBuffer(e){return new h(e.length).get(e,0)}constructor(e){this.len=e}get(e,t){const s=F[r.get(e,t)];t+=4;const a=r.get(e,t);t+=4;const c=new y(a,"utf-8").get(e,t);t+=a;const g=r.get(e,t);t+=4;const d=new y(g,"utf-8").get(e,t);t+=g;const l=r.get(e,t);t+=4;const p=r.get(e,t);t+=4;const U=r.get(e,t);t+=4;const T=r.get(e,t);t+=4;const b=r.get(e,t);t+=4;const C=Uint8Array.from(e.slice(t,t+b));return{type:s,format:c,description:d,width:l,height:p,colour_depth:U,indexed_color:T,data:C}}}const m={len:7,get:(n,e)=>({packetType:w.get(n,e),vorbis:new y(6,"ascii").get(n,e+1)})},H={len:23,get:(n,e)=>({version:i.get(n,e+0),channelMode:w.get(n,e+4),sampleRate:i.get(n,e+5),bitrateMax:i.get(n,e+9),bitrateNominal:i.get(n,e+13),bitrateMin:i.get(n,e+17)})};class k{constructor(e,t){this.data=e,this.offset=t}readInt32(){const e=i.get(this.data,this.offset);return this.offset+=4,e}readStringUtf8(){const e=this.readInt32(),t=new TextDecoder("utf-8").decode(this.data.subarray(this.offset,this.offset+e));return this.offset+=e,t}parseUserComment(){const e=this.offset,t=this.readStringUtf8(),s=t.indexOf("=");return{key:t.slice(0,s).toUpperCase(),value:t.slice(s+1),len:this.offset-e}}}const o=L("music-metadata:parser:ogg:vorbis1");class u extends S("Vorbis"){}class P{constructor(e,t){this.pageSegments=[],this.metadata=e,this.options=t}async parsePage(e,t){if(this.lastPageHeader=e,e.headerType.firstPage)this.parseFirstPage(e,t);else{if(e.headerType.continued){if(this.pageSegments.length===0)throw new u("Cannot continue on previous page");this.pageSegments.push(t)}if(e.headerType.lastPage||!e.headerType.continued){if(this.pageSegments.length>0){const s=P.mergeUint8Arrays(this.pageSegments);await this.parseFullPage(s)}this.pageSegments=e.headerType.lastPage?[]:[t]}}}static mergeUint8Arrays(e){const t=e.reduce((a,c)=>a+c.length,0),s=new Uint8Array(t);return e.forEach((a,c,g)=>{const d=g.slice(0,c).reduce((l,p)=>l+p.length,0);s.set(a,d)}),s}async flush(){await this.parseFullPage(P.mergeUint8Arrays(this.pageSegments))}async parseUserComment(e,t){const a=new k(e,t).parseUserComment();return await this.addTag(a.key,a.value),a.len}async addTag(e,t){if(e==="METADATA_BLOCK_PICTURE"&&typeof t=="string"){if(this.options.skipCovers){o("Ignore picture");return}t=h.fromBase64(t),o(`Push picture: id=${e}, format=${t.format}`)}else o(`Push tag: id=${e}, value=${t}`);await this.metadata.addTag("vorbis",e,t)}calculateDuration(){this.lastPageHeader&&this.metadata.format.sampleRate&&this.lastPageHeader.absoluteGranulePosition>=0&&(this.metadata.setFormat("numberOfSamples",this.lastPageHeader.absoluteGranulePosition),this.metadata.setFormat("duration",this.lastPageHeader.absoluteGranulePosition/this.metadata.format.sampleRate))}parseFirstPage(e,t){this.metadata.setFormat("codec","Vorbis I"),this.metadata.setFormat("hasAudio",!0),o("Parse first page");const s=m.get(t,0);if(s.vorbis!=="vorbis")throw new u("Metadata does not look like Vorbis");if(s.packetType===1){const a=H.get(t,m.len);this.metadata.setFormat("sampleRate",a.sampleRate),this.metadata.setFormat("bitrate",a.bitrateNominal),this.metadata.setFormat("numberOfChannels",a.channelMode),o("sample-rate=%s[hz], bitrate=%s[b/s], channel-mode=%s",a.sampleRate,a.bitrateNominal,a.channelMode)}else throw new u("First Ogg page should be type 1: the identification header")}async parseFullPage(e){const t=m.get(e,0);switch(o("Parse full page: type=%s, byteLength=%s",t.packetType,e.byteLength),t.packetType){case 3:return this.parseUserCommentList(e,m.len)}}async parseUserCommentList(e,t){const s=i.get(e,t);t+=4,t+=s;let a=i.get(e,t);for(t+=4;a-- >0;)t+=await this.parseUserComment(e,t)}}export{P as V,k as a,h as b};
//# sourceMappingURL=VorbisStream-BQnc4-mp.js.map

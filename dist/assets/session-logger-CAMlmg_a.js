import{a8 as B,aa as J,C as $,r as l,c as A,y as v}from"./index-xeh6oSzU.js";var O=(a=>(a[a.SESSION_START=0]="SESSION_START",a[a.SESSION_END=1]="SESSION_END",a[a.PAGE_VIEW=2]="PAGE_VIEW",a[a.AUTH_LOGIN_ATTEMPT=10]="AUTH_LOGIN_ATTEMPT",a[a.AUTH_LOGIN_SUCCESS=11]="AUTH_LOGIN_SUCCESS",a[a.AUTH_LOGIN_FAILURE=12]="AUTH_LOGIN_FAILURE",a[a.AUTH_LOGOUT=13]="AUTH_LOGOUT",a[a.AUTH_TOKEN_REFRESH=14]="AUTH_TOKEN_REFRESH",a[a.AUTH_IMPERSONATION_START=15]="AUTH_IMPERSONATION_START",a[a.AUTH_IMPERSONATION_STOP=16]="AUTH_IMPERSONATION_STOP",a[a.AUDIO_SOURCE_CHANGE=20]="AUDIO_SOURCE_CHANGE",a[a.AUDIO_TRACK_START=21]="AUDIO_TRACK_START",a[a.AUDIO_TRACK_END=22]="AUDIO_TRACK_END",a[a.AUDIO_TRACK_SKIP=23]="AUDIO_TRACK_SKIP",a[a.AUDIO_VOLUME_CHANGE=24]="AUDIO_VOLUME_CHANGE",a[a.AUDIO_SEEK=25]="AUDIO_SEEK",a[a.AUDIO_PAUSE=26]="AUDIO_PAUSE",a[a.AUDIO_RESUME=27]="AUDIO_RESUME",a[a.SHADER_CHANGE=30]="SHADER_CHANGE",a[a.VARIANT_TWEEN=31]="VARIANT_TWEEN",a[a.PROJECT_CREATE=32]="PROJECT_CREATE",a[a.PROJECT_EDIT=33]="PROJECT_EDIT",a[a.PROJECT_SHARE=34]="PROJECT_SHARE",a[a.UI_CLICK=40]="UI_CLICK",a[a.UI_MODAL_OPEN=41]="UI_MODAL_OPEN",a[a.UI_MODAL_CLOSE=42]="UI_MODAL_CLOSE",a[a.UI_SETTING_CHANGE=43]="UI_SETTING_CHANGE",a[a.UI_KEYBOARD_SHORTCUT=44]="UI_KEYBOARD_SHORTCUT",a[a.COMPONENT_LOAD=50]="COMPONENT_LOAD",a[a.API_REQUEST=51]="API_REQUEST",a[a.API_RESPONSE=52]="API_RESPONSE",a[a.ERROR_OCCURRED=53]="ERROR_OCCURRED",a[a.PERFORMANCE_METRIC=54]="PERFORMANCE_METRIC",a[a.SOCKET_CONNECT=60]="SOCKET_CONNECT",a[a.SOCKET_DISCONNECT=61]="SOCKET_DISCONNECT",a[a.REAL_TIME_MESSAGE=62]="REAL_TIME_MESSAGE",a[a.ACTIVE_SPACE_JOIN=63]="ACTIVE_SPACE_JOIN",a[a.ACTIVE_SPACE_LEAVE=64]="ACTIVE_SPACE_LEAVE",a))(O||{}),E=(a=>(a[a.LOW=0]="LOW",a[a.MEDIUM=1]="MEDIUM",a[a.HIGH=2]="HIGH",a[a.CRITICAL=3]="CRITICAL",a))(E||{});const x=B("sessionLogger",()=>{const a=J(),f=$(),o=l(h()),c=l(Date.now()),C=l(!0),n=l(!1),e=l({0:{events:[],lastFlush:Date.now(),flushInterval:1e4},1:{events:[],lastFlush:Date.now(),flushInterval:5e3},2:{events:[],lastFlush:Date.now(),flushInterval:2e3},3:{events:[],lastFlush:Date.now(),flushInterval:0}}),I=l(null),g=l(0),U=l(0),N=A(()=>Object.values(e.value).reduce((t,r)=>t+r.events.length,0)),_=l({0:null,1:null,2:null,3:null});function h(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function m(){const t=localStorage.getItem("anonymousSessionId");if(t)return t;const r=`anon_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return localStorage.setItem("anonymousSessionId",r),r}function D(){return f.walletAddress||null}function G(){const t=Date.now();return{page:window.location.pathname,route:window.location.pathname,userAgent:navigator.userAgent,deviceType:/Mobile|Android|iPhone|iPad/.test(navigator.userAgent)?/iPad|tablet/.test(navigator.userAgent)?"tablet":"mobile":"desktop",clientPlatform:"web",viewport:{width:window.innerWidth,height:window.innerHeight},previousEventType:I.value||void 0,sessionDuration:t-c.value}}function S(t){switch(t){case 0:case 1:case 11:case 12:case 53:return 3;case 10:case 13:case 21:case 2:case 32:return 2;case 20:case 22:case 30:case 51:case 41:return 1;case 24:case 40:case 54:case 31:return 0;default:return 0}}function K(t){return t>=10&&t<20?"auth":t>=20&&t<30?"audio":t>=30&&t<40?"creative":t>=40&&t<50?"ui":t>=50&&t<60?"performance":t>=60&&t<70?"collaboration":"session"}function i(t,r={},u){if(!C.value)return;const s={timestamp:Date.now(),sessionId:o.value,userId:D(),anonymousId:D()?void 0:m(),eventType:t,eventCategory:K(t),eventData:r,context:{...G(),...u}};I.value=t,g.value++,n.value&&console.log("ðŸ“Š Session Event:",{type:O[t],category:s.eventCategory,data:r,sessionDuration:`${(s.context.sessionDuration/1e3).toFixed(1)}s`});const R=S(t);e.value[R].events.push(s),R===3&&d(R)}async function d(t){const r=e.value[t];if(r.events.length===0)return;const u=[...r.events];r.events=[],r.lastFlush=Date.now();try{await b(u),U.value+=u.length,n.value&&u.length>1&&console.log(`ðŸ“Š Flushed ${u.length} events (priority: ${E[t]})`)}catch(s){console.error("ðŸ“Š Failed to send events:",s),r.events.unshift(...u)}}async function b(t){if(t.length!==0)if(a.connected)a.emit("session:log-events",{events:t});else{const r=await fetch("/api/log",{method:"POST",headers:{"Content-Type":"application/json",...f.authToken&&{Authorization:`Bearer ${f.authToken}`}},body:JSON.stringify({events:t})});if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`)}}function w(){Object.entries(e.value).forEach(([t,r])=>{const u=parseInt(t);u!==3&&(_.value[u]&&clearInterval(_.value[u]),_.value[u]=window.setInterval(()=>{r.events.length>0&&d(u)},r.flushInterval))})}function L(){Object.entries(_.value).forEach(([t,r])=>{r&&(clearInterval(r),_.value[parseInt(t)]=null)})}async function P(){const t=Object.keys(e.value).map(r=>{const u=parseInt(r);return d(u)});await Promise.all(t)}function H(){o.value=h(),c.value=Date.now(),I.value=null,i(0,{userAgent:navigator.userAgent,referrer:document.referrer,initialPage:window.location.pathname}),w(),n.value&&console.log("ðŸ“Š Session started:",o.value)}async function M(){i(1,{duration:Date.now()-c.value,totalEvents:g.value}),await P(),L(),n.value&&console.log("ðŸ“Š Session ended:",o.value)}function F(t){C.value=t,t&&!_.value[0]?w():t||L()}function T(t){n.value=t}const V=A(()=>({sessionId:o.value,duration:Date.now()-c.value,eventsLogged:g.value,eventsSent:U.value,eventsBuffered:N.value,lastEventType:I.value?O[I.value]:null}));return H(),v(async()=>{await M()}),typeof window<"u"&&window.addEventListener("beforeunload",()=>{if(navigator.sendBeacon&&N.value>0){const t=[];if(Object.values(e.value).forEach(r=>{t.push(...r.events)}),t.length>0){const r=JSON.stringify({events:t});navigator.sendBeacon("/api/session/log",r)}}}),{sessionId:A(()=>o.value),sessionStartTime:A(()=>c.value),isLoggingEnabled:A(()=>C.value),isVerboseLogging:A(()=>n.value),sessionStats:V,logEvent:i,startSession:H,endSession:M,setLoggingEnabled:F,setVerboseLogging:T,flushAllBuffers:P,SessionEventType:O,EventPriority:E}});export{E as EventPriority,O as SessionEventType,x as useSessionLogger};
//# sourceMappingURL=session-logger-CAMlmg_a.js.map

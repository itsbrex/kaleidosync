{"version":3,"sources":["kaleidosync/kaleidoscope.js"],"names":["Array","prototype","randomElement","Math","floor","random","length","Kaleidoscope","halt","canvas","Canvas","totalStars","maxSize","isMobile","window","innerHeight","innerWidth","minSize","activeSize","sizeStep","radiusStep","colorSchemes","Colors","activeColorScheme","duration","radiusDuration","colorDuration","backgroundDuration","refreshRate","model","stars","last","active","background","setEventHooks","buildSingleState","pingSpotify","events","beforeInit","setActiveColorScheme","initElements","beforeStart","startPaint","afterStop","clearTweeningIntervals","stopPaint","init","setColorState","setRadiusState","tweenStarRadius","tweenStarColor","tweenBackgroundColor","setTimeout","initialized","i","numPoints","starState","x","width","y","height","points","color","innerRadius","outerRadius","star","Star","addStar","backgroundState","addBackground","Rectangle","size","parseInt","clearInterval","radiusTween","colorTween","negative","ms","next","innerStep","outerStep","innerTween","outerTween","setInterval","isNaN","update","element","setColor","stepR","stepG","stepB","tweenR","tweenG","tweenB","slice","split","tweenRGB","colors","negArray","concat","setBackgroundState","intervals","hooks","tatums","segments","nextLoudness","loudness_max","lastLoudness","activeLoudness","trackFeatures","loudness","beats","bars","Visualizer"],"mappings":"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","file":"kaleidoscope.js","sourcesContent":["import Visualizer from './visualizer'\nimport Canvas from './canvas'\nimport Star from './star'\nimport Rectangle from './rectangle'\nimport Colors from './colors'\n\nArray.prototype.randomElement = function() {\n  return this[Math.floor(Math.random() * this.length)]\n}\n\nclass Kaleidoscope extends Visualizer {\n  constructor(halt) {\n    super(halt)\n        \n    this.halt = halt\n    this.canvas = new Canvas('kaleidoscope')\n    this.totalStars = 16 \n    this.maxSize = (this.canvas.isMobile ? 1.2 : .5) * (window.innerHeight > window.innerWidth ? window.innerHeight : window.innerWidth)\n    this.minSize = this.maxSize / 5\n    this.activeSize = this.halt ? this.maxSize : this.minSize\n    this.sizeStep = [\n      ((this.maxSize / this.totalStars) * 0.4),\n      ((this.maxSize / this.totalStars) * 0.6),\n      ((this.maxSize / this.totalStars) * 0.8)\n    ]\n    this.radiusStep = [.1, .2, .3, .4, .5, .6, .7, .8, .9, 1, 1.1, 1.2]\n    this.colorSchemes = Colors\n    this.activeColorScheme = []\n    this.duration = 5000 \n    this.radiusDuration = this.duration\n    this.colorDuration = this.duration\n    this.backgroundDuration = this.duration\n    this.refreshRate = 1000/60\n    this.model = {\n      stars: { last: [],\n        active: []\n      },\n      background: {\n        last: {},\n        active: {}\n      }\n    }\n\n    this.setEventHooks()\n\n    if (this.halt === true) {\n      this.buildSingleState(true)\n    } else {\n      this.pingSpotify(true)\n    } \n  }\n\n  setEventHooks() {\n    this.events.beforeInit = () => {\n      this.setActiveColorScheme()\n      this.initElements()\n    }\n\n    this.events.beforeStart = () => {\n      this.canvas.startPaint()\n    }\n\n    this.events.afterStop = () => {\n      this.clearTweeningIntervals()\n      this.canvas.stopPaint()\n    }\n  }\n\n  buildSingleState(init) {\n    this.activeSize = this.maxSize\n\n    if (init) {\n      this.initElements()\n    } \n\n    this.setActiveColorScheme()\n    this.setColorState()\n    this.setRadiusState()\n\n    if (!init) {\n      this.tweenStarRadius()\n      this.tweenStarColor() \n      this.tweenBackgroundColor()\n    }\n\n    if (init) { \n      this.buildSingleState()\n\n      setTimeout(() => {\n        this.clearTweeningIntervals()\n        this.canvas.stopPaint()\n      }, this.duration)\n    }\n  }\n\n  initElements() {\n    if (this.initialized === true) {\n      return\n    }\n\n    for (var i = 0; i < this.totalStars; i++) {\n      let numPoints = 16\n\n      if ((i + 1) % 2 === 0) { numPoints = 24 }\n      if ((i + 1) % 3 === 0) { numPoints = 8  }\n      if ((i + 1) % 4 === 0) { numPoints = 32 }\n\n      let starState = {\n        x: this.canvas.width/2,\n        y: this.canvas.height/2,\n        points: numPoints,\n        color: 'rgb(255,255,255)',\n        innerRadius: 0,\n        outerRadius: 0\n      }\n\n      let star = new Star(starState)\n\n      this.model.stars.active[i] = starState\n      this.model.stars.last[i] = starState\n      this.canvas.addStar(star)\n    }\n\n    let backgroundState = {\n      color: 'rgb(255,255,255)',\n      width: this.canvas.width,\n      height: this.canvas.height\n    }\n\n    this.model.background.active = backgroundState\n    this.model.background.last = backgroundState\n    this.canvas.addBackground(new Rectangle(backgroundState))\n    this.canvas.init()\n    this.initialized = true\n  }\n\n  setRadiusState() {\n    let size = this.activeSize\n\n    for (var i = 0; i < this.totalStars; i++) {\n      size = parseInt(size - this.sizeStep.randomElement())\n\n      if (size < this.minSize ) {\n        size = this.minSize\n      } \n\n      clearInterval(this.canvas.stars[i].radiusTween)\n\n      this.model.stars.last[i].innerRadius = this.model.stars.active[i].innerRadius\n      this.model.stars.last[i].outerRadius = this.model.stars.active[i].outerRadius\n      this.model.stars.active[i].innerRadius = size * this.radiusStep.randomElement()\n      this.model.stars.active[i].outerRadius = size\n    }\n  }\n\n  setColorState() { \n    for (var i = 0; i < this.totalStars; i++) {\n      clearInterval(this.canvas.stars[i].colorTween)\n\n      this.model.stars.last[i] = {\n        ...this.model.stars.last[i],\n        color: this.model.stars.active[i].color\n      }\n\n      this.model.stars.active[i].color = this.activeColorScheme.randomElement()\n    }\n  }\n\n  setBackgroundState(negative) {\n    clearInterval(this.canvas.background.colorTween)\n\n    this.model.background.last = {\n      ...this.model.background.last,\n      color: this.model.background.active.color\n    }\n\n    this.model.background.active = {\n      ...this.model.background.active, \n      color: negative\n    }\n  }\n\n  tweenStarRadius(ms) {\n    let duration = ms ? ms : this.radiusDuration\n\n    for (let i = 0; i < this.totalStars; i++) {\n      let star = this.canvas.stars[i]\n      let next = this.model.stars.active[i]\n      let last = this.model.stars.last[i]\n      let innerStep = (next.innerRadius - last.innerRadius) / (duration / this.refreshRate)\n      let outerStep = (next.outerRadius - last.outerRadius) / (duration / this.refreshRate)\n      let innerTween = last.innerRadius\n      let outerTween = last.outerRadius\n\n      star.radiusTween = setInterval(() => {\n        innerTween = innerTween + innerStep\n        outerTween = outerTween + outerStep\n\n        next.innerRadius = innerTween\n        next.outerRadius = outerTween\n\n        if (!isNaN(innerTween)) {\n          star.update({\n            innerRadius: innerTween,\n            outerRadius: outerTween\n          })\n        } else {\n          clearInterval(star.radiusTween)\n        }\n      }, this.refreshRate)\n    }\n  }\n\n  tweenRGB(duration, next, last, element, setColor) {\n    let stepR = (parseInt(next[0]) - parseInt(last[0])) / (duration / this.refreshRate)\n    let stepG = (parseInt(next[1]) - parseInt(last[1])) / (duration / this.refreshRate)\n    let stepB = (parseInt(next[2]) - parseInt(last[2])) / (duration / this.refreshRate)\n    \n    let tweenR = parseInt(last[0])\n    let tweenG = parseInt(last[1])\n    let tweenB = parseInt(last[2])\n\n    element.colorTween = setInterval(() => {\n      tweenR = parseInt(tweenR + stepR)\n      tweenG = parseInt(tweenG + stepG)\n      tweenB = parseInt(tweenB + stepB)\n\n      setColor(`rgb(${tweenR}, ${tweenG}, ${tweenB})`)\n    }, this.refreshRate)\n  }\n\n  tweenStarColor(ms) {\n    let duration = ms ? ms : this.colorDuration\n\n    for (let i = 0; i < this.totalStars; i++) {\n      let next = this.model.stars.active[i].color.slice(4, -1).split(',')\n      let last = this.model.stars.last[i].color.slice(4, -1).split(',')\n      \n      this.tweenRGB(duration, next, last, this.canvas.stars[i], (color) => {\n        this.model.stars.active[i].color = color\n        this.canvas.stars[i].update({ color })\n      })\n    }\n  }\n\n  tweenBackgroundColor(ms) {\n    let duration = ms ? ms : this.backgroundDuration\n    let next = this.model.background.active.color.slice(4, -1).split(',')\n    let last = this.model.background.last.color.slice(4, -1).split(',')\n\n    this.tweenRGB(duration, next, last, this.canvas.background, (color) => {\n      this.model.background.active.color = color \n      this.canvas.background.update({ color })\n    })\n  }\n\n  setActiveColorScheme() {\n    let colors = this.colorSchemes.randomElement()\n    let negative = colors.randomElement()\n    let negArray = [negative, negative, negative, negative]\n\n    this.activeColorScheme = colors.concat(negArray)\n    this.setBackgroundState(negative)\n  }\n\n  clearTweeningIntervals() {\n    if (this.initialized) {\n      for (var i = 0; i < this.totalStars; i++) {\n        clearInterval(this.canvas.stars[i].radiusTween)\n        clearInterval(this.canvas.stars[i].colorTween)\n      }\n\n      clearInterval(this.canvas.background.colorTween)\n    }\n  }\n  \n  setIntervalHooks() {\n    this.intervals.hooks.tatums = () => {\n      this.radiusDuration = this.intervals.active.tatums.duration * 1000\n      this.setRadiusState()  \n      this.tweenStarRadius() \n    }\n\n    this.intervals.hooks.segments = () => {\n      const nextLoudness = this.intervals.next.segments ? this.intervals.next.segments.loudness_max : this.intervals.active.segments.loudness_max\n      const lastLoudness = this.intervals.last.segments ? this.intervals.last.segments.loudness_max : this.intervals.active.segments.loudness_max\n      const activeLoudness = (this.intervals.active.segments.loudness_max + nextLoudness + lastLoudness)/3\n\n      this.activeSize = (this.maxSize - (activeLoudness * -25)) + (this.trackFeatures.loudness * -10)\n    }\n\n    this.intervals.hooks.beats = () => {  \n      this.colorDuration = this.intervals.active.beats.duration * 1000\n      this.setColorState() \n      this.tweenStarColor()\n    }\n\n    this.intervals.hooks.bars = () => {\n      this.backgroundDuration = this.intervals.active.bars.duration * 1000\n      this.setActiveColorScheme()\n      this.tweenBackgroundColor()\n    }\n  } \n}\n\nexport default Kaleidoscope"]}